<!DOCTYPE html> <!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--> <!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--> <!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--> <!--[if gt IE 8]><!--> <html class="no-js"><!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"> <title>Selecting Model Parameters &#8211; In the Helix</title> <meta name="description" content="In the Helix is a place to post my thoughts on science and other things."> <meta name="keywords" content="Tutorial, Optimization"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="http://localhost:4000/assets/img/new_logo.png"> <meta name="twitter:title" content="Selecting Model Parameters"> <meta name="twitter:description" content="Performing a Grid Search to Select Regression Parameters"> <meta name="twitter:site" content="@CpGenome"> <meta name="twitter:creator" content="@CpGenome"> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Selecting Model Parameters"> <meta property="og:description" content="Performing a Grid Search to Select Regression Parameters"> <meta property="og:url" content="http://localhost:4000/ChoosingModelParameters/"> <meta property="og:site_name" content="In the Helix"> <meta property="og:image" content="http://localhost:4000/assets/img/new_logo.png"> <link rel="canonical" href="http://localhost:4000/ChoosingModelParameters/"> <link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="In the Helix Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="http://localhost:4000/assets/css/main.css"> <!-- JS --> <script src="http://localhost:4000/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="http://localhost:4000/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="http://localhost:4000/favicon.png" /> <link rel="shortcut icon" href="http://localhost:4000/favicon.ico" /> <!-- Background Image --> <style type="text/css">body {background-image:url(http://localhost:4000/assets/img/background.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="http://localhost:4000/">Home</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="http://localhost:4000/assets/img/new_logo.png" alt="In the Helix photo" class="author-photo"> <h4>In the Helix</h4> <p>In the Helix is a place to post my thoughts on science and other things.</p> </li> <li><a href="http://localhost:4000/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="http://twitter.com/CpGenome" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a> </li> <li> <a href="http://github.com/NuttyLogic" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> </ul><!-- /.dl-submenu --> </li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="http://localhost:4000/posts/">All Posts</a></li> <li><a href="http://localhost:4000/tags/">All Tags</a></li> </ul> </li> <li><a href="http://localhost:4000/projects/" >Tools</a></li> <li><a href="http://localhost:4000/teaching/" >BIG Summer</a></li> </ul><!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Selecting Model Parameters</h1> <h4>03 Jul 2018</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~6 minutes </p><!-- /.entry-reading-time --> <a class="btn zoombtn" href="http://localhost:4000/teaching/"> <i class="fa fa-chevron-left"></i> </a> </div> <h1 id="selecting-model-parameters">Selecting Model Parameters</h1> <p>Selecting model parameters is a computationally expensive task, generally there is not an easy way to select the best parameters. As a result selecting the best model parameters comes down to testing all possible combinations of models parameters. To speed up this process we will run each combination of parameters in parallel across nodes in a cluster with a job scheduler, sun/oracle grid engine (SGE), in place.</p> <p>To choose parameters we will make use of custom code for parameter selection,<a href="https://github.com/NuttyLogic/SciKitLearnModelSelection">SciKitLearnModelSelection</a>. To import classes from this library include the library directory in your python path, then import as normal. We will make use of test data from from <a href="https://www.ncbi.nlm.nih.gov/pubmed/23034122">Aging effects on DNA methylation modules in human brain and blood tissue, 5</a>, data cleaning was performed in an earlier tutorial on fitting an <a href="https://nuttylogic.github.io/EpigeneticClockExample/">epigentic clock</a>.</p> <h3 id="data-import-and-preprocessing">Data Import and Preprocessing</h3> <p>We first want to set paths our working directory and the save the file name as a variable.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Set working directory and input data path</span>
<span class="n">wd</span> <span class="o">=</span> <span class="s">'path to working directory'</span>
<span class="n">geo_file</span> <span class="o">=</span> <span class="s">'file name'</span>
</code></pre></div></div> <p>We want to modify the python system paths to import external files to process the data and wrap Sci-Kit Learn models.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sklearn_model_wrappers</span> <span class="o">=</span> <span class="s">'path_to_/SciKitLearnModelSelction'</span>
<span class="n">series_matrix_parsers</span> <span class="o">=</span> <span class="s">'path_to_/matrix_parsers'</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sklearn_model_wrappers</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">series_matrix_parsers</span><span class="p">)</span>
</code></pre></div></div> <p>With the python path modified, we now import all of the external libraries we will employ for the analysis.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">ParameterRandomization</span> <span class="kn">import</span> <span class="n">RandomizeParameters</span>
<span class="kn">from</span> <span class="nn">BatchJobGenerator</span> <span class="kn">import</span>  <span class="n">LaunchOptimizationJob</span>
<span class="kn">from</span> <span class="nn">SeriesMatrixParser</span> <span class="kn">import</span> <span class="n">SeriesMatrixParser</span>
</code></pre></div></div> <h3 id="data-preprocessing">Data Preprocessing</h3> <p>Data preprocessing will follow the same workflow as a previous tutorial on fitting an <a href="https://nuttylogic.github.io/EpigeneticClockExample/">epigenetic clock</a>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># import and parse the methylation data</span>
<span class="n">example_matrix</span> <span class="o">=</span> <span class="n">SeriesMatrixParser</span><span class="p">(</span><span class="n">f</span><span class="s">'{wd}{geo_file}'</span><span class="p">)</span>
<span class="n">example_matrix</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">description_ids</span><span class="o">=</span><span class="p">[</span><span class="s">'!Series_title'</span><span class="p">,</span> <span class="s">'!Series_geo_accession'</span><span class="p">,</span> <span class="s">'!Series_pubmed_id'</span><span class="p">,</span> <span class="s">'!Series_summary'</span><span class="p">,</span>
                             <span class="s">'!Series_overall_design'</span><span class="p">,</span> <span class="s">'!Series_sample_id'</span><span class="p">,</span> <span class="s">'!Series_relation'</span><span class="p">],</span>
               <span class="n">sample_id</span><span class="o">=</span><span class="s">'!Sample_geo_accession'</span><span class="p">,</span>
               <span class="n">phenotype_ids</span><span class="o">=</span><span class="p">[</span><span class="s">'!Sample_characteristics_ch1'</span><span class="p">],</span>
               <span class="n">matrix_start</span><span class="o">=</span><span class="s">'!series_matrix_table_begin'</span><span class="p">)</span>
<span class="c"># initialize a pandas dataframe</span>
<span class="n">example_matrix_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">example_matrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">example_matrix</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">example_matrix_df</span> <span class="o">=</span> <span class="n">example_matrix_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s">'"ID_REF"'</span><span class="p">)</span>
<span class="n">example_matrix_df</span> <span class="o">=</span> <span class="n">example_matrix_df</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">'coerce'</span><span class="p">)</span>
<span class="c"># drop row containing null values</span>
<span class="n">example_matrix_df</span> <span class="o">=</span> <span class="n">example_matrix_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c"># collect phenotype info</span>
<span class="n">example_matrix_age</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">example_matrix</span><span class="o">.</span><span class="n">phenotype_matrix</span><span class="p">[</span><span class="s">'age'</span><span class="p">]]</span>
</code></pre></div></div> <p>As part of the preprocessing step we will perform PCA and remove outliers.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># define a PCA object</span>
<span class="n">qc_pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">whiten</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c"># fit the PCA object</span>
<span class="n">qc_pca_values</span> <span class="o">=</span> <span class="n">qc_pca</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">example_matrix_df</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">pc1</span> <span class="o">=</span> <span class="n">qc_pca_values</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">pc2</span> <span class="o">=</span> <span class="n">qc_pca_values</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>

<span class="c"># scatter plot of first two PCs, and retrieve and sample outliers</span>
<span class="c"># list to store sample outliers</span>
<span class="n">non_outlier_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">non_outlier_age</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c"># iterate through pc1, pc2, and sample labels to add labels to plotted points</span>
<span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">age</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pc1</span><span class="p">,</span> <span class="n">pc2</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">example_matrix_df</span><span class="p">),</span> <span class="n">example_matrix_age</span><span class="p">):</span>
    <span class="c"># add outliers to list</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">non_outlier_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">non_outlier_age</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
</code></pre></div></div> <h2 id="split-data-into-a-testing-and-validation-set">Split Data into a Testing and Validation Set</h2> <p>We want to split the data into a testing and training dataset. For downstream analysis we will drop all of the outlier samples.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># want a list of sample names</span>
<span class="n">sample_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">example_matrix_df</span><span class="p">[</span><span class="n">non_outlier_list</span><span class="p">])</span>

<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">sample_ids</span><span class="p">,</span> <span class="n">non_outlier_age</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

<span class="c"># take dataframe values as a numpy array and transpose the array with .T</span>
<span class="n">X_train_array</span> <span class="o">=</span> <span class="n">example_matrix_df</span><span class="p">[</span><span class="n">X_train</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
<span class="n">X_test_array</span> <span class="o">=</span> <span class="n">example_matrix_df</span><span class="p">[</span><span class="n">X_test</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span>
</code></pre></div></div> <h2 id="parameters-search">Parameters Search</h2> <p>To search for parameters we will modify a dictionary of standard input arguments. We will then pass a dictionary containing lists for different parameters we want to consider. All combination of parameters will be considered, so there is a practical limit to the number of parameters that can be feasibly searched. As a general strategy I first consider a few dramatic parameter changes then perform a more focused parameter search based on the results from the first search. In this example we will modify parameters for SKLearn <a href="http://scikit-learn.org/stable/modules/generated/sklearn.linear_model.ElasticNetCV.html">ElasticNetCV</a>. The default argument for the ElasticNetCV are list below.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Create a dictionary with default arguments</span>
<span class="n">elastic_net_default</span> <span class="o">=</span> <span class="p">{</span><span class="s">'l1_ratio'</span><span class="p">:</span><span class="mf">0.5</span><span class="p">,</span>
                       <span class="s">'eps'</span><span class="p">:</span><span class="mf">0.001</span><span class="p">,</span>
                       <span class="s">'n_alphas'</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span>
                       <span class="s">'alphas'</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
                       <span class="s">'fit_intercept'</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
                       <span class="s">'normalize'</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                       <span class="s">'precompute'</span><span class="p">:</span><span class="s">'auto'</span><span class="p">,</span>
                       <span class="s">'max_iter'</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span>
                       <span class="s">'tol'</span><span class="p">:</span><span class="mf">0.0001</span><span class="p">,</span>
                       <span class="s">'cv'</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
                       <span class="s">'copy_X'</span><span class="p">:</span><span class="bp">True</span><span class="p">,</span>
                       <span class="s">'verbose'</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span>
                       <span class="s">'n_jobs'</span><span class="p">:</span><span class="mi">8</span><span class="p">,</span>
                       <span class="s">'positive'</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span>
                       <span class="s">'random_state'</span><span class="p">:</span><span class="bp">None</span><span class="p">,</span>
                       <span class="s">'selection'</span><span class="p">:</span><span class="s">'cyclic'</span><span class="p">}</span>
</code></pre></div></div> <p>For this example we will consider model with different lasso penalty weights and the different path lengths. We initialize a dictionary with lists of values for the parameters we are interested in searching. We pass this dictionary along with the default arguments dictionary into the RandomizeParameters class, this class return a tuple of dictionaries that contain all combinations of the input arguments.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">parameter_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">'l1_ratio'</span><span class="p">:[</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">9</span><span class="p">],</span> <span class="s">'eps'</span><span class="p">:[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">]}</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">en_kwargs_tuple</span> <span class="o">=</span> <span class="n">RandomizeParameters</span><span class="p">(</span><span class="n">input_dictionary</span><span class="o">=</span><span class="n">elastic_net_default</span><span class="p">,</span> <span class="n">randomization_dictionary</span><span class="o">=</span><span class="n">parameter_dict</span><span class="p">)</span><span class="o">.</span><span class="n">get_randomized_parameters</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">en_kwargs_tuple</span><span class="p">)</span>
</code></pre></div></div> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>({'l1_ratio': 0.1, 'eps': 0.01, 'n_alphas': 100, 'alphas': None, 'fit_intercept': True, 'normalize': False, 'precompute': 'auto', 'max_iter': 1000, 'tol': 0.0001, 'cv': None, 'copy_X': True, 'verbose': 0, 'n_jobs': 8, 'positive': False, 'random_state': None, 'selection': 'cyclic'}, {'l1_ratio': 0.1, 'eps': 0.0001, 'n_alphas': 100, 'alphas': None, 'fit_intercept': True, 'normalize': False, 'precompute': 'auto', 'max_iter': 1000, 'tol': 0.0001, 'cv': None, 'copy_X': True, 'verbose': 0, 'n_jobs': 8, 'positive': False, 'random_state': None, 'selection': 'cyclic'}, {'l1_ratio': 0.9, 'eps': 0.01, 'n_alphas': 100, 'alphas': None, 'fit_intercept': True, 'normalize': False, 'precompute': 'auto', 'max_iter': 1000, 'tol': 0.0001, 'cv': None, 'copy_X': True, 'verbose': 0, 'n_jobs': 8, 'positive': False, 'random_state': None, 'selection': 'cyclic'}, {'l1_ratio': 0.9, 'eps': 0.0001, 'n_alphas': 100, 'alphas': None, 'fit_intercept': True, 'normalize': False, 'precompute': 'auto', 'max_iter': 1000, 'tol': 0.0001, 'cv': None, 'copy_X': True, 'verbose': 0, 'n_jobs': 8, 'positive': False, 'random_state': None, 'selection': 'cyclic'})
</code></pre></div></div> <p>With the model parameters set, we will now specify paths to data and data labels, and convert the list to a tuple to ensure immutability.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">regression_dict_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">grid_search</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">en_kwargs_tuple</span><span class="p">):</span>
    <span class="n">regression_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">'x'</span><span class="p">:</span><span class="n">X_train_array</span><span class="p">,</span>
                       <span class="s">'y'</span><span class="p">:</span><span class="n">y_train</span><span class="p">,</span>
                       <span class="s">'sample_labels'</span><span class="p">:</span><span class="n">X_train</span><span class="p">,</span>
                       <span class="s">'sk_elastic_net_kwargs'</span><span class="p">:</span><span class="n">grid_search</span><span class="p">,</span>
                       <span class="s">'regression_site_labels'</span><span class="p">:</span><span class="nb">list</span><span class="p">(</span><span class="n">example_matrix_df</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
                       <span class="s">'output_name'</span><span class="p">:</span><span class="n">f</span><span class="s">'{count}_grid_search.txt'</span><span class="p">,</span>
                       <span class="s">'output_directory'</span><span class="p">:</span><span class="n">wd</span><span class="p">,</span>
                       <span class="s">'test_split'</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
    <span class="n">regression_dict_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regression_dict</span><span class="p">)</span>
<span class="n">regression_dict_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">regression_dict_list</span><span class="p">)</span>
</code></pre></div></div> <h2 id="launch-gridsearch-job">Launch Gridsearch Job</h2> <p>To fit the model we input SGE specifications for the job. We will specify the number of cores, the memory required, the time required for the job, the user name, the SGE report output folder, and the number of simultaneous jobs. Finally we will have to specify where the model interface is located on the server, this is necessary to call a job within python and parse the necessary information. When the class is initialized a serialized file containing all the input data is placed in the the output folder. This serialized file is then loaded by the model interface when the resources become available to run the job.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">grid_search</span> <span class="o">=</span>  <span class="n">LaunchOptimizationJob</span><span class="p">(</span><span class="n">dictionary_tuple</span><span class="o">=</span><span class="n">regression_dict_tuple</span><span class="p">,</span>
                                    <span class="n">model_interface</span><span class="o">=</span><span class="s">'~/LaunchElasticNet.py'</span><span class="p">,</span>
                                     <span class="n">sge_cores</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                     <span class="n">sge_mem</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                     <span class="n">sge_time</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">simultaneous_jobs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                                     <span class="n">optimization_batch_name</span><span class="o">=</span><span class="s">'ex_age'</span><span class="p">,</span>
                                     <span class="n">optimization_batch_directory</span><span class="o">=</span><span class="n">wd</span><span class="p">,</span>
                                     <span class="n">sge_output_folder</span><span class="o">=</span><span class="s">'sge_report_output'</span><span class="p">,</span>
                                     <span class="n">sge_user</span><span class="o">=</span><span class="s">'sge username'</span><span class="p">)</span>

</code></pre></div></div> <h2 id="import-first-search-jobs">Import First Search Jobs</h2> <p>After running the jobs we would like to check the results. First we will define functions to parse the output information then we can launch additional jobs if necessary to further search the parameter space.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">line_split</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">model_info_parser</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">parsed_file</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="s">'r'</span><span class="p">)</span> <span class="k">as</span> <span class="n">info</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">parsed_file</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">parsed_file</span>

<span class="k">def</span> <span class="nf">model_f_dict</span><span class="p">(</span><span class="n">parsed_list</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'label'</span><span class="p">]</span> <span class="o">=</span> <span class="n">parsed_list</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'.txt'</span><span class="p">,</span> <span class="s">''</span><span class="p">)</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'score'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parsed_list</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">' '</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'arguments'</span><span class="p">]</span> <span class="o">=</span> <span class="n">parsed_list</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'test_samples'</span><span class="p">]</span> <span class="o">=</span> <span class="n">parsed_list</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'test_predicted'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parsed_list</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'test_actual'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parsed_list</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'training_samples'</span><span class="p">]</span> <span class="o">=</span> <span class="n">parsed_list</span><span class="p">[</span><span class="mi">7</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'training_actual'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">parsed_list</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">1</span><span class="p">:]]</span>
    <span class="n">model</span><span class="p">[</span><span class="s">'regression_sites'</span><span class="p">]</span> <span class="o">=</span> <span class="n">parsed_list</span><span class="p">[</span><span class="mi">9</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">model</span>

<span class="k">def</span> <span class="nf">format_model_info</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="n">p_list</span> <span class="o">=</span> <span class="n">model_info_parser</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">p_dict</span> <span class="o">=</span> <span class="n">model_f_dict</span><span class="p">(</span><span class="n">p_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_dict</span>
</code></pre></div></div> <p>Import model results, and look at performance.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model_info_container</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">regression_dict_tuple</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">model</span><span class="p">[</span><span class="s">'output_name'</span><span class="p">]</span>
    <span class="n">info_path</span> <span class="o">=</span> <span class="n">f</span><span class="s">'{wd}{name}.model_info.txt'</span>
    <span class="n">model_info_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_model_info</span><span class="p">(</span><span class="n">info_path</span><span class="p">))</span>
</code></pre></div></div> <p>Plot histogram of R^2 values.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">score_container</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_info_container</span><span class="p">:</span>
    <span class="n">score_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">[</span><span class="s">'score'</span><span class="p">])</span>

<span class="n">ax</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">score_container</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Model Performance'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Count'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'R**2'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div></div> <p><img src="https://github.com/NuttyLogic/NuttyLogic.github.io/blob/master/posts/post_assets/parameter_optimization/model_score.png?raw=true" alt="" /></p> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="http://localhost:4000/tags/#Tutorial" title="Pages tagged Tutorial" class="tag"><span class="term">Tutorial</span></a><a href="http://localhost:4000/tags/#Optimization" title="Pages tagged Optimization" class="tag"><span class="term">Optimization</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/ChoosingModelParameters/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/ChoosingModelParameters/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=http://localhost:4000/ChoosingModelParameters/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> </header> <!-- JS --> <script src="http://localhost:4000/assets/js/jquery-1.12.0.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.dlmenu.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.goup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.magnific-popup.min.js"></script> <script src="http://localhost:4000/assets/js/jquery.fitvid.min.js"></script> <script src="http://localhost:4000/assets/js/scripts.js"></script> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
